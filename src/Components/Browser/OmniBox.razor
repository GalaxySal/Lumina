@namespace tauri_browser.Components.Browser
@using System.Text.Json.Serialization
@using tauri_browser.Models

<div class="toolbar">
    <div class="nav-controls" style="display: flex; gap: 4px;">
        <button class="nav-btn" @onclick="OnBack" disabled="@(!CanGoBack)" title="Geri">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 20px; height: 20px;">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
            </svg>
        </button>
        <button class="nav-btn" @onclick="OnForward" disabled="@(!CanGoForward)" title="İleri">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 20px; height: 20px;">
                <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
            </svg>
        </button>
        <button class="nav-btn" @onclick="OnRefresh" title="Yenile">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 20px; height: 20px;">
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
            </svg>
        </button>
    </div>

    <div class="url-container" style="flex-grow: 1; margin: 0 8px; position: relative;">
        <input type="text" class="url-input" 
               value="@_tempUrl"
               @oninput="HandleInput"
               @onkeyup="HandleKeyUp" 
               @onfocus="OnFocus"
               @onblur="OnBlur"
               placeholder="Web adresini girin veya arama yapın..." 
               style="padding-right: 32px;" />
        
        <!-- Sidekick Status Icon -->
        <div class="sidekick-status" title="Sidekick Aktif (Safkan Yapı)" 
             style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); color: #10b981; opacity: 0.8;">
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 18px; height: 18px;">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z" />
             </svg>
        </div>
        
        @if (ShowSuggestions)
        {
            <div class="omnibox-suggestions" style="position: absolute; top: 100%; left: 0; right: 0; background: #252525; border: 1px solid #333; border-radius: 0 0 8px 8px; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.3); max-height: 400px; overflow-y: auto;">
                @foreach (var item in Suggestions)
                {
                    <div class="suggestion-item" @onclick="() => SelectSuggestion(item)" style="padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #333;">
                        <div class="icon" style="width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; color: #aaa;">
                            @if (item.Icon == "search") {
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg>
                            } else if (item.Icon == "globe") {
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S12 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S12 3 12 3m0 0a8.997 8.997 0 017.843 4.582M12 3a8.997 8.997 0 00-7.843 4.582m15.686 0A11.953 11.953 0 0112 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0112 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 013 12c0-1.605.546-3.091 1.437-4.319" /></svg>
                            } else if (item.Icon == "video") {
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.348a1.125 1.125 0 010 1.971l-11.54 6.347a1.125 1.125 0 01-1.667-.985V5.653z" /></svg>
                            } else if (item.Icon == "cpu") {
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 3v1.5M4.5 8.25H3m18 0h-1.5M4.5 12H3m18 0h-1.5m-15 3.75H3m18 0h-1.5M8.25 19.5V21M12 3v1.5m0 15V21m3.75-18v1.5m0 15V21m-9-1.5h10.5a2.25 2.25 0 002.25-2.25V6.75a2.25 2.25 0 00-2.25-2.25H6.75A2.25 2.25 0 004.5 6.75v10.5a2.25 2.25 0 002.25 2.25z" /></svg>
                            } else if (item.Icon == "trash") {
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>
                            } else {
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg>
                            }
                        </div>
                        <div class="content">
                            <div class="title" style="font-size: 13px; color: #fff;">@item.Title</div>
                            <div class="url" style="font-size: 11px; color: #666;">@item.Url</div>
                        </div>
                    </div>
                }
            </div>
        }
    </div>

    <div class="window-controls">
        <!-- Settings button placeholder -->
         <button class="nav-btn" title="Ayarlar">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 20px; height: 20px;">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
            </svg>
        </button>
    </div>
</div>

@code {
    [Parameter] public string CurrentUrl { get; set; } = "";
    [Parameter] public bool CanGoBack { get; set; }
    [Parameter] public bool CanGoForward { get; set; }
    [Parameter] public bool IsLoading { get; set; }
    
    [Parameter] public EventCallback OnBack { get; set; }
    [Parameter] public EventCallback OnForward { get; set; }
    [Parameter] public EventCallback OnRefresh { get; set; }
    [Parameter] public EventCallback<string> OnNavigate { get; set; }
    
    // Smart Search
    [Parameter] public List<SuggestionItem> Suggestions { get; set; } = new();
    [Parameter] public EventCallback<string> OnInput { get; set; }

    private string _tempUrl = "";
    private bool _showSuggestions = false;
    private bool ShowSuggestions => _showSuggestions && Suggestions != null && Suggestions.Count > 0;

    protected override void OnParametersSet()
    {
        if (!_showSuggestions) // Only update if not actively typing/showing suggestions
        {
            _tempUrl = CurrentUrl;
        }
    }

    private async Task HandleInput(ChangeEventArgs e)
    {
        var val = e.Value?.ToString() ?? "";
        _tempUrl = val;
        _showSuggestions = true;
        if (OnInput.HasDelegate)
        {
            await OnInput.InvokeAsync(val);
        }
    }

    private void OnFocus()
    {
        _showSuggestions = true;
    }

    private async Task OnBlur()
    {
        // Delay hide to allow click
        await Task.Delay(200);
        _showSuggestions = false;
        StateHasChanged();
    }
    
    private async Task HandleKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
             _showSuggestions = false;
            await OnNavigate.InvokeAsync(_tempUrl);
        }
    }

    private async Task SelectSuggestion(SuggestionItem item)
    {
        _tempUrl = item.Url;
        _showSuggestions = false;
        await OnNavigate.InvokeAsync(item.Url);
    }
}
