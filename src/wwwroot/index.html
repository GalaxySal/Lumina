<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Lumina Browser</title>
    <base href="./" />
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <link rel="stylesheet" href="css/app.css" />
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' http://tauri.localhost http://ipc.localhost tauri:; script-src 'self' 'unsafe-inline' 'unsafe-eval' 'wasm-unsafe-eval' tauri: http://tauri.localhost; style-src 'self' 'unsafe-inline' http://tauri.localhost; connect-src 'self' http://ipc.localhost http://tauri.localhost https:; img-src 'self' data: https: asset: blob:; frame-src 'self' https: http:; font-src 'self' data:;">

    <!-- Safkan: No external fonts/CDNs. Native look & feel. -->
    <style>
        /* Modern Dark Loader */
        body {
            margin: 0;
            background-color: #0f0f0f;
            overflow: hidden;
        }

        #app {
            height: 100vh;
            width: 100vw;
            position: relative;
        }

        /* The .lumina-splash style block has been removed as per instruction */

        .loader {
            width: 48px;
            height: 48px;
            border: 3px solid #333;
            border-bottom-color: #05B8CC;
            /* Lumina Cyan */
            border-radius: 50%;
            animation: rotation 1s linear infinite;
            margin-bottom: 24px;
        }

        .brand {
            font-weight: 600;
            letter-spacing: 2px;
            font-size: 0.9rem;
            color: #888;
            text-transform: uppercase;
        }

        @keyframes rotation {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div id="app">
        <!-- Blazor will mount here -->
    </div>

    <script>
        /**
         * LUMINA SAFKAN BRIDGE
         * Connects Blazor WASM to Tauri Rust Backend
         */

        // Define Global Bridge Immediately
        window.lumina = window.lumina || {};

        window.lumina.invoke = async (cmd, args) => {
            if (window.__TAURI__ && window.__TAURI__.core) {
                return await window.__TAURI__.core.invoke(cmd, args);
            }
            // Fallback for dev
            if (cmd === "get_settings") return { vertical_tabs: false };
            console.warn("Lumina: Tauri invoke not available for", cmd);
        };

        window.lumina.hideSplashScreen = () => {
            // Function kept for compatibility with call in Home.razor, but effectively a no-op now
            console.log("Lumina: Splash screen removed.");
        };

        window.lumina.listen = async (event, dotNetHelper) => {
            if (window.__TAURI__ && window.__TAURI__.event) {
                return await window.__TAURI__.event.listen(event, (e) => {
                    dotNetHelper.invokeMethodAsync('OnEvent', e.payload);
                });
            }
            console.warn("Lumina: Tauri listen not available for", event);
        };

        window.setupTabNavigationListener = async (dotNetRef) => {
            // 1. Global Keyboard Shortcuts
            window.addEventListener('keydown', (e) => {
                // Ctrl + L: Focus Address Bar
                if (e.ctrlKey && e.code === 'KeyL') {
                    e.preventDefault();
                    const input = document.querySelector('.url-input');
                    if (input) { input.select(); input.focus(); }
                }

                // Ctrl + Shift + T: Restore Closed Tab
                if (e.ctrlKey && e.shiftKey && e.code === 'KeyT') {
                    e.preventDefault();
                    dotNetRef.invokeMethodAsync('RestoreLastClosedTab');
                }
            });

            // 2. Tauri Event Listeners
            if (window.__TAURI__ && window.__TAURI__.event) {
                const eventMap = {
                    'tab-navigation': (e) => dotNetRef.invokeMethodAsync('OnTabNavigation', e.payload.label, e.payload.url),
                    'download-started': (e) => dotNetRef.invokeMethodAsync('OnDownloadStarted', e.payload),
                    'download-progress': (e) => dotNetRef.invokeMethodAsync('OnDownloadProgress', e.payload),
                    'download-finished': (e) => dotNetRef.invokeMethodAsync('OnDownloadFinished', e.payload),
                    'tab-created': (e) => dotNetRef.invokeMethodAsync('OnTabCreated', e.payload),
                    'tab-updated': (e) => dotNetRef.invokeMethodAsync('OnTabUpdated', e.payload),
                    'request-new-tab': (e) => dotNetRef.invokeMethodAsync('OnNewTabRequested', e.payload),
                    'pwa-can-install': (e) => dotNetRef.invokeMethodAsync('OnPwaDetected', e.payload.label),
                    'adblock-stats-update': (e) => dotNetRef.invokeMethodAsync('OnAdblockStatsUpdate', e.payload),
                    'omnibox-results': (e) => dotNetRef.invokeMethodAsync('OnOmniboxResults', e.payload),
                    'toggle-command-palette': () => {
                        if (window.commandPaletteRef) window.commandPaletteRef.invokeMethodAsync('Toggle');
                    }
                };

                // Register all listeners
                for (const [evt, handler] of Object.entries(eventMap)) {
                    await window.__TAURI__.event.listen(evt, handler);
                }

            } else {
                console.warn("Lumina: Tauri environment not detected. Running in browser mode.");
            }
        };

        window.registerCommandPaletteShortcut = (dotNetRef) => {
            window.commandPaletteRef = dotNetRef;
        };

        window.measureElementHeight = (selector) => {
            const el = document.querySelector(selector);
            return el ? el.getBoundingClientRect().height : 0;
        };
    </script>
    <script src="_framework/blazor.webassembly.js"></script>
    <script>
        window.lumina.setTextScale = (scale) => {
            document.documentElement.style.setProperty('--text-scale', scale.replace('%', '') / 100);
        };
    </script>
</body>

</html>