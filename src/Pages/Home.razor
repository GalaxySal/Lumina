@page "/"
@using System.Text.Json.Serialization
@inject IJSRuntime JsRuntime

@using tauri_browser.Components

<div class="browser-container @(Settings.VerticalTabs ? "vertical-mode" : "")" style="@ThemeStyle">
    <CommandPalette OnNavigate="HandleCommandPaletteNavigate" BlockedAdsCount="@ActiveTabBlockedCount" />
    <!-- Tab Bar -->
    <div class="tab-bar">
        <div class="tabs-scroll-area">
            @foreach (var tab in Tabs)
            {
                <div class="tab @(tab.Id == ActiveTabId ? "active" : "")" @onclick="() => SwitchTab(tab.Id)">
                    @if (!string.IsNullOrEmpty(tab.FaviconUrl))
                    {
                        <img src="@tab.FaviconUrl" class="tab-icon" onerror="this.style.display='none'" />
                    }
                    else
                    {
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="tab-icon-default">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 017.843 4.582M12 3a8.997 8.997 0 00-7.843 4.582m15.686 0A11.953 11.953 0 0112 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0112 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 013 12c0-1.605.42-3.113 1.157-4.418" />
                        </svg>
                    }
                    <span class="tab-title">@(string.IsNullOrEmpty(tab.Title) ? "Yeni Sekme" : tab.Title)</span>
                    <span class="tab-close" @onclick="() => CloseTab(tab.Id)" @onclick:stopPropagation>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 14px; height: 14px;">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </span>
                </div>
            }
        </div>
        <button class="new-tab-btn" @onclick="CreateNewTab">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 20px; height: 20px;">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
        </button>
    </div>

    <div class="content-area">
        <!-- Toolbar -->
        <div class="toolbar">
            <button class="nav-btn" @onclick="GoBack" title="Back">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 20px; height: 20px;">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
                </svg>
            </button>
            <button class="nav-btn" @onclick="GoForward" title="Forward">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 20px; height: 20px;">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
                </svg>
            </button>
            <button class="nav-btn" @onclick="Refresh" title="Refresh">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 20px; height: 20px;">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>
            </button>
            
            <div class="url-container">
                <button class="icon-btn" title="Enhanced Tracking Protection (Active)" style="color: #4ade80; margin-right: 4px;">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z" />
                    </svg>
                </button>
                <div style="flex: 1; position: relative;">
                    <input class="url-input" value="@CurrentUrl" @oninput="HandleInput" @onkeyup="HandleKeyUp" placeholder="Enter URL or search..." style="width: 100%;" />
                    @if (ShowSuggestions)
                    {
                        <div class="suggestions-dropdown">
                            @foreach (var item in Suggestions)
                            {
                                <div class="suggestion-item" @onclick="() => SelectSuggestion(item)">
                                    <span class="suggestion-icon">
                                        @if (item.VisitCount == 100) { <span>‚≠ê</span> } else { <span>üïí</span> }
                                    </span>
                                    <div class="suggestion-text">
                                        <div class="suggestion-title">@item.Title</div>
                                        <div class="suggestion-url">@item.Url</div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
                <button class="icon-btn" @onclick="InstallPwa" title="Uygulamayƒ± Y√ºkle" disabled="@IsInstallingPwa" style="@(IsPwaAvailable ? "margin-right: 4px;" : "display: none")">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                    </svg>
                </button>
                <button class="icon-btn" @onclick="ToggleReaderMode" title="Toggle Reader View" style="margin-right: 4px;">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
                    </svg>
                </button>
                <button class="icon-btn" @onclick="ToggleFavorite" title="@(IsCurrentFavorite ? "Remove from Favorites" : "Add to Favorites")">
                    @if (IsCurrentFavorite)
                    {
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px; color: #fbbf24;">
                          <path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.006z" clip-rule="evenodd" />
                        </svg>
                    }
                    else
                    {
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.563.045.797.77.371 1.141l-4.197 3.655a.562.562 0 00-.168.513l1.285 5.386a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.168-.513l-4.197-3.655c-.426-.372-.192-1.096.371-1.141l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" />
                        </svg>
                    }
                </button>
            </div>
            
            <button class="nav-btn" @onclick="Navigate" title="Go">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 20px; height: 20px;">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
                </svg>
            </button>
            <button class="nav-btn" @onclick="ToggleMenu" title="Menu">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 20px; height: 20px;">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                </svg>
            </button>
        </div>

        <!-- Webview Container -->
        <div id="webview-container">
            <!-- The native webview will be positioned here by Rust -->
        </div>
    </div>
    
    <!-- Menu Overlay -->
    @if (IsMenuOpen)
    {
        <div class="menu-overlay" @onclick="CloseMenu"></div>
        <div class="menu-sidebar">
            <div class="menu-header">
                <button class="menu-tab @(MenuTab == "history" ? "active" : "")" @onclick="@(() => MenuTab = "history")">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 20px; height: 20px;">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>History</span>
                </button>
                <button class="menu-tab @(MenuTab == "favorites" ? "active" : "")" @onclick="@(() => MenuTab = "favorites")">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 20px; height: 20px;">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.563.045.797.77.371 1.141l-4.197 3.655a.562.562 0 00-.168.513l1.285 5.386a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.168-.513l-4.197-3.655c-.426-.372-.192-1.096.371-1.141l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" />
                    </svg>
                    <span>Favorites</span>
                </button>
                <button class="menu-tab @(MenuTab == "downloads" ? "active" : "")" @onclick="@(() => MenuTab = "downloads")">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 20px; height: 20px;">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                    </svg>
                    <span>Downloads</span>
                </button>
                <button class="menu-tab @(MenuTab == "settings" ? "active" : "")" @onclick="@(() => MenuTab = "settings")">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 20px; height: 20px;">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span>Settings</span>
                </button>
                <button class="menu-tab @(MenuTab == "networking" ? "active" : "")" @onclick="@(() => MenuTab = "networking")">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 20px; height: 20px;">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 3v1.5M4.5 8.25H3m18 0h-1.5M4.5 12h1.5m-1.5 3.75H3m18 0h-1.5M8.25 19.5V21M12 3v1.5m0 15V21m3.75-18v1.5m0 15V21m-9-1.5h10.5a2.25 2.25 0 002.25-2.25V6.75a2.25 2.25 0 00-2.25-2.25H6.75A2.25 2.25 0 004.5 6.75v10.5a2.25 2.25 0 002.25 2.25z" />
                    </svg>
                    <span>Network</span>
                </button>
            </div>
            <div class="menu-content">
                @if (MenuTab == "history")
                {
                    <ul class="list">
                        @foreach (var item in HistoryList)
                        {
                            <li @onclick="() => LoadUrl(item.Url)" class="list-item">
                                <div class="item-title">@item.Title</div>
                                <div class="item-url">@item.Url</div>
                            </li>
                        }
                    </ul>
                }
                else if (MenuTab == "favorites")
                {
                    <ul class="list">
                        @foreach (var item in FavoritesList)
                        {
                            <li class="list-item fav-item">
                                <div class="fav-info" @onclick="() => LoadUrl(item.Url)">
                                    <div class="item-title">@item.Title</div>
                                    <div class="item-url">@item.Url</div>
                                </div>
                                <button class="delete-btn" @onclick="() => RemoveFavorite(item.Url)" title="Remove">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;">
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                                    </svg>
                                </button>
                            </li>
                        }
                    </ul>
                }
                else if (MenuTab == "downloads")
                {
                    <ul class="list">
                        @if (!DownloadsList.Any())
                        {
                             <li class="list-item"><div class="item-title">No downloads yet</div></li>
                        }
                        @foreach (var item in DownloadsList)
                        {
                            <li class="list-item">
                                <div class="item-title">@item.FileName</div>
                                <div class="item-url" style="color: @(item.Status == "Completed" ? "green" : (item.Status == "Failed" ? "red" : "blue"))">@item.Status</div>
                                @if (item.Status == "Downloading" && item.Total > 0)
                                {
                                    <div class="progress-bar-container" style="width: 100%; background: #eee; height: 5px; margin-top: 5px;">
                                        <div class="progress-bar" style="width: @(item.Progress * 100 / item.Total)%; background: var(--accent-color); height: 100%;"></div>
                                    </div>
                                    <div class="item-url">@((item.Progress * 100 / item.Total))%</div>
                                }
                                <div class="item-url">@item.Url</div>
                                <div style="display: flex; gap: 8px; margin-top: 5px;">
                                    @if (item.Status == "Completed" && !string.IsNullOrEmpty(item.Path))
                                    {
                                        <button class="nav-btn" style="font-size: 12px; width: auto; padding: 4px 8px;" @onclick="() => OpenFile(item.Path)" title="Dosyayƒ± A√ß">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 14px; height: 14px; margin-right: 4px;">
                                              <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" />
                                            </svg>
                                            A√ß
                                        </button>
                                        <button class="nav-btn" style="font-size: 12px; width: auto; padding: 4px 8px;" @onclick="() => ShowInFolder(item.Path)" title="Klas√∂rde G√∂ster">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 14px; height: 14px; margin-right: 4px;">
                                              <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z" />
                                            </svg>
                                            Klas√∂r
                                        </button>
                                    }
                                    <button class="nav-btn" style="font-size: 12px; width: auto; padding: 4px 8px;" @onclick="() => CopyLink(item.Url)" title="Baƒülantƒ±yƒ± Kopyala">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 14px; height: 14px; margin-right: 4px;">
                                          <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5" />
                                        </svg>
                                        Link
                                    </button>
                                </div>
                            </li>
                        }
                    </ul>
                }
                else if (MenuTab == "settings")
                {
                    <div class="settings-panel">
                        <h3>General</h3>
                        <div class="form-group">
                            <label>Homepage URL</label>
                            <input class="form-control" @bind="Settings.Homepage" />
                        </div>
                        <div class="form-group">
                            <label>Search Engine</label>
                            <select class="form-control" @bind="Settings.SearchEngine">
                                <option value="google">Google</option>
                                <option value="bing">Bing</option>
                                <option value="duckduckgo">DuckDuckGo</option>
                            </select>
                        </div>
                        
                        <h3>Appearance</h3>
                        <div class="form-group">
                            <label>Theme</label>
                            <select class="form-control" @bind="Settings.Theme">
                                <option value="dark">Dark</option>
                                <option value="light">Light</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Accent Color</label>
                            <input type="color" class="form-control form-control-color" @bind="Settings.AccentColor" />
                        </div>
                        <div class="form-group checkbox-group">
                            <label>
                                <input type="checkbox" @bind="Settings.VerticalTabs" />
                                Use Vertical Tabs (Zen Mode)
                            </label>
                        </div>
                        <div class="form-group checkbox-group">
                            <label>
                                <input type="checkbox" @bind="Settings.RoundedCorners" />
                                Rounded Corners
                            </label>
                        </div>

                        <button class="save-btn" @onclick="SaveSettings">Save & Apply</button>
                    </div>
                }
                else if (MenuTab == "networking")
                {
                    <div class="networking-panel" style="padding: 20px;">
                        <h3>Go Sidecar Control</h3>
                        <div class="status-indicator" style="margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.1); border-radius: 8px;">
                            <strong>Status:</strong> @NetworkStatus
                        </div>
                        
                        <div class="control-group" style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <button class="nav-btn" style="width: auto; padding: 8px 16px;" @onclick='() => RunNetworkCommand("ping", "{}")'>Ping</button>
                            <button class="nav-btn" style="width: auto; padding: 8px 16px;" @onclick='() => RunNetworkCommand("status", "{}")'>Check Status</button>
                        </div>
                        
                        <h3>Server Configuration</h3>
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px;">Port</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" class="form-control" @bind="NetworkPort" style="width: 100px;" />
                                <button class="nav-btn" style="width: auto; padding: 8px 16px; background-color: var(--accent-color); color: white;" @onclick="StartServer">Start Server</button>
                                <button class="nav-btn" style="width: auto; padding: 8px 16px; background-color: #ef4444; color: white;" @onclick="StopServer">Stop</button>
                            </div>
                        </div>

                        <h3>Logs</h3>
                        <div class="logs" style="background: #1e1e1e; color: #d4d4d4; padding: 10px; border-radius: 8px; font-family: monospace; height: 200px; overflow-y: auto; font-size: 12px;">
                            @if (!NetworkLogs.Any())
                            {
                                <div style="color: #666;">No logs yet...</div>
                            }
                            @foreach(var log in NetworkLogs)
                            {
                                <div class="log-entry" style="border-bottom: 1px solid #333; padding: 2px 0;">@log</div>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    }
</div>



@code {
    private class BrowserTab
    {
        public string Id { get; set; } = "tab-" + Guid.NewGuid().ToString();
        public string Title { get; set; } = "Yeni Sekme";
        public string Url { get; set; } = "https://tauri.app";
        public string FaviconUrl { get; set; } = string.Empty;
        public bool IsPwaAvailable { get; set; } = false;
        public uint BlockedAdsCount { get; set; } = 0;
    }

    private List<BrowserTab> Tabs = new();
    private string ActiveTabId = string.Empty;
    private uint ActiveTabBlockedCount => Tabs.FirstOrDefault(t => t.Id == ActiveTabId)?.BlockedAdsCount ?? 0;
    private string CurrentUrl { get; set; } = string.Empty;
    private bool IsPwaAvailable { get; set; } = false;
    private string CurrentPwaTabId { get; set; } = string.Empty;
    private bool IsInstallingPwa = false;
    
    private bool IsMenuOpen = false;
    private string MenuTab = "history";
    private bool IsCurrentFavorite = false;
    private AppSettings Settings = new AppSettings();
    
    private List<HistoryItem> HistoryList = new();
    private List<FavoriteItem> FavoritesList = new();
    private List<DownloadItem> DownloadsList = new();

    private class HistoryItem 
    { 
        public string Url { get; set; } = string.Empty; 
        public string Title { get; set; } = string.Empty; 
        [JsonPropertyName("visit_count")]
        public long VisitCount { get; set; }
        [JsonPropertyName("last_visit")]
        public long LastVisit { get; set; }
    }
    private class FavoriteItem { public string Url { get; set; } = string.Empty; public string Title { get; set; } = string.Empty; }
    
    // Suggestions
    private List<HistoryItem> Suggestions = new();
    private bool ShowSuggestions => Suggestions.Any() && !string.IsNullOrWhiteSpace(CurrentUrl);

    private bool _suggestionsLayoutPending = false;

    private async Task HandleInput(ChangeEventArgs e)
    {
        CurrentUrl = e.Value?.ToString() ?? string.Empty;
        
        if (string.IsNullOrWhiteSpace(CurrentUrl))
        {
            Suggestions.Clear();
        }
        else
        {
            try
            {
                Suggestions = await JsRuntime.InvokeAsync<List<HistoryItem>>("__TAURI__.core.invoke", "search_history", new { query = CurrentUrl });
            }
            catch (Exception)
            {
                // Console.WriteLine($"Error fetching suggestions: {ex.Message}");
                Suggestions.Clear();
            }
        }
        _suggestionsLayoutPending = true;
    }

    private async Task SearchHistory(string query)
    {
         try
        {
            Suggestions = await JsRuntime.InvokeAsync<List<HistoryItem>>("__TAURI__.core.invoke", "search_history", new { query = query });
            _suggestionsLayoutPending = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching suggestions: {ex.Message}");
            Suggestions.Clear();
        }
    }

    private async Task UpdateSuggestionsLayout()
    {
        double height = 0;
        if (ShowSuggestions)
        {
            try 
            {
                height = await JsRuntime.InvokeAsync<double>("measureElementHeight", ".suggestions-dropdown");
                // Add buffer for margin-top (4px) and shadow (approx 6px)
                if (height > 0) height += 10; 
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error measuring suggestions height: {ex.Message}");
                // Fallback to estimation if JS fails
                var count = Suggestions.Count;
                height = Math.Min(count * 55 + 10, 400);
            }
        }
        
        try
        {
            await JsRuntime.InvokeVoidAsync("__TAURI__.core.invoke", "set_suggestions_height", new { height = (uint)height });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error setting suggestions height: {ex.Message}");
        }
    }

    private async Task SelectSuggestion(HistoryItem item)
    {
        CurrentUrl = item.Url;
        Suggestions.Clear();
        _suggestionsLayoutPending = true;
        await Navigate();
    }
    
    public class DownloadItem
    {
        [JsonPropertyName("url")]
        public string Url { get; set; } = string.Empty;
        
        [JsonPropertyName("file_name")]
        public string FileName { get; set; } = string.Empty;
        
        [JsonPropertyName("status")]
        public string Status { get; set; } = "Downloading";
        
        [JsonPropertyName("path")]
        public string Path { get; set; } = string.Empty;
        
        [JsonPropertyName("downloaded_size")]
        public ulong Progress { get; set; } = 0;
        
        [JsonPropertyName("total_size")]
        public ulong Total { get; set; } = 0;
    }

    public class DownloadStartedPayload
    {
        [JsonPropertyName("url")]
        public string Url { get; set; } = string.Empty;
        [JsonPropertyName("file_name")]
        public string FileName { get; set; } = string.Empty;
    }

    public class DownloadProgressPayload
    {
        [JsonPropertyName("url")]
        public string Url { get; set; } = string.Empty;
        [JsonPropertyName("progress")]
        public ulong Progress { get; set; } = 0;
        [JsonPropertyName("total")]
        public ulong Total { get; set; } = 0;
    }

    public class DownloadFinishedPayload
    {
        [JsonPropertyName("url")]
        public string Url { get; set; } = string.Empty;
        [JsonPropertyName("success")]
        public bool Success { get; set; } = false;
        [JsonPropertyName("path")]
        public string? Path { get; set; } = string.Empty;
    }

    public class TabCreatedPayload
    {
        public string Label { get; set; } = string.Empty;
        public string Url { get; set; } = string.Empty;
    }

    public class TabUpdatedPayload
    {
        [JsonPropertyName("label")]
        public string Label { get; set; } = string.Empty;
        
        [JsonPropertyName("title")]
        public string? Title { get; set; }
        
        [JsonPropertyName("favicon")]
        public string? Favicon { get; set; }
    }

    public class AdblockStatsPayload
    {
        [JsonPropertyName("label")]
        public string Label { get; set; } = string.Empty;
        
        [JsonPropertyName("blocked_count")]
        public uint BlockedCount { get; set; }
    }
    
    public class AppSettings
    {
        public string Homepage { get; set; } = "https://www.google.com";
        public string SearchEngine { get; set; } = "google";
        public string Theme { get; set; } = "dark";
        public string AccentColor { get; set; } = "#3b82f6";
        public bool VerticalTabs { get; set; } = false;
        public bool RoundedCorners { get; set; } = true;
    }

    private string ThemeStyle => $"--bg-color: {(Settings.Theme == "dark" ? "#1B1B1E" : "#ffffff")}; --header-bg: {(Settings.Theme == "dark" ? "#1B1B1E" : "#dee1e6")}; --toolbar-bg: {(Settings.Theme == "dark" ? "#202124" : "#ffffff")}; --menu-bg: {(Settings.Theme == "dark" ? "#292A2D" : "rgba(255, 255, 255, 0.95)")}; --text-color: {(Settings.Theme == "dark" ? "#E8EAED" : "#1f2937")}; --tab-text: {(Settings.Theme == "dark" ? "#9AA0A6" : "#4b5563")}; --tab-active-text: {(Settings.Theme == "dark" ? "#F1F3F4" : "#111827")}; --tab-inactive-bg: {(Settings.Theme == "dark" ? "transparent" : "rgba(229, 231, 235, 0.5)")}; --tab-active-bg: {(Settings.Theme == "dark" ? "#323639" : "#ffffff")}; --tab-hover-bg: {(Settings.Theme == "dark" ? "#28292C" : "rgba(255,255,255,0.5)")}; --btn-hover-bg: {(Settings.Theme == "dark" ? "rgba(255,255,255,0.1)" : "rgba(0,0,0,0.08)")}; --url-bg: {(Settings.Theme == "dark" ? "#2A2A2B" : "rgba(0,0,0,0.06)")}; --url-bg-focus: {(Settings.Theme == "dark" ? "#3C4043" : "#ffffff")}; --border-color: {(Settings.Theme == "dark" ? "#3C4043" : "rgba(229, 231, 235, 0.5)")}; --accent-color: {Settings.AccentColor}; --border-radius: {(Settings.RoundedCorners ? "12px" : "0px")};";

    protected override async Task OnInitializedAsync()
    {
        await LoadSettings();
        
        // Auto-start/check Go Network Sidecar
        // This ensures the sidecar is working immediately upon browser launch
        _ = RunNetworkCommand("status", "{}");

        try
        {
             var downloads = await JsRuntime.InvokeAsync<List<DownloadItem>>("__TAURI__.core.invoke", "get_downloads");
             if (downloads != null)
             {
                 DownloadsList = downloads; 
                 
                 var pending = downloads.Where(d => d.Status == "downloading" || d.Status == "failed").ToList();
                 if (pending.Count > 0)
                 {
                      // Simple confirmation
                      bool resume = await JsRuntime.InvokeAsync<bool>("confirm", $"Yarƒ±m kalan {pending.Count} indirme var. Devam edilsin mi?");
                      if (resume)
                      {
                          foreach(var item in pending)
                          {
                              item.Status = "downloading"; 
                              await JsRuntime.InvokeVoidAsync("__TAURI__.core.invoke", "resume_download", new { url = item.Url });
                          }
                          StateHasChanged();
                      }
                 }
             }
        }
        catch (Exception ex) { Console.WriteLine($"Error checking downloads: {ex.Message}"); }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
             try
             {
                var dotNetRef = DotNetObjectReference.Create(this);
                await JsRuntime.InvokeVoidAsync("setupTabNavigationListener", dotNetRef);

                // Create the initial tab
                await CreateNewTab();
             }
             catch (Exception ex)
             {
                Console.WriteLine($"Error creating initial tab: {ex.Message}");
             }
        }

        if (_suggestionsLayoutPending)
        {
            _suggestionsLayoutPending = false;
            await UpdateSuggestionsLayout();
        }
    }

    [JSInvokable]
    public void OnDownloadStarted(DownloadStartedPayload payload)
    {
        DownloadsList.Insert(0, new DownloadItem 
        { 
            Url = payload.Url, 
            FileName = payload.FileName, 
            Status = "Downloading" 
        });
        StateHasChanged();
        
        // Auto-open menu to downloads? Maybe too intrusive.
        // But let's verify it works.
    }

    [JSInvokable]
    public void OnDownloadProgress(DownloadProgressPayload payload)
    {
        var item = DownloadsList.FirstOrDefault(d => d.Url == payload.Url && d.Status == "Downloading");
        if (item != null)
        {
            item.Progress = payload.Progress;
            item.Total = payload.Total;
            StateHasChanged();
        }
    }

    [JSInvokable]
    public void OnDownloadFinished(DownloadFinishedPayload payload)
    {
        var item = DownloadsList.FirstOrDefault(d => d.Url == payload.Url && d.Status == "Downloading");
        if (item != null)
        {
            item.Status = payload.Success ? "Completed" : "Failed";
            item.Path = payload.Path ?? string.Empty;
        }
        else
        {
             DownloadsList.Insert(0, new DownloadItem 
            { 
                Url = payload.Url, 
                FileName = System.IO.Path.GetFileName(payload.Path ?? payload.Url), 
                Status = payload.Success ? "Completed" : "Failed",
                Path = payload.Path ?? string.Empty
            });
        }
        StateHasChanged();
    }

    [JSInvokable]
    public void OnTabCreated(TabCreatedPayload payload)
    {
        if (Tabs.Any(t => t.Id == payload.Label)) return;

        var newTab = new BrowserTab { 
            Id = payload.Label, 
            Url = payload.Url,
            Title = "Yeni Sekme"
        };
        Tabs.Add(newTab);
        ActiveTabId = newTab.Id;
        CurrentUrl = newTab.Url;
        StateHasChanged();
    }

    [JSInvokable]
    public void OnTabUpdated(TabUpdatedPayload payload)
    {
        Console.WriteLine($"Tab updated: {payload.Label}, Title: {payload.Title}, Favicon: {payload.Favicon}");
        var tab = Tabs.FirstOrDefault(t => t.Id == payload.Label);
        if (tab != null)
        {
            if (!string.IsNullOrEmpty(payload.Title)) tab.Title = payload.Title;
            if (!string.IsNullOrEmpty(payload.Favicon)) tab.FaviconUrl = payload.Favicon;
            StateHasChanged();
        }
    }

    [JSInvokable]
    public void OnPwaDetected(string label)
    {
        var tab = Tabs.FirstOrDefault(t => t.Id == label);
        if (tab != null)
        {
            tab.IsPwaAvailable = true;
            if (ActiveTabId == label)
            {
                IsPwaAvailable = true;
                CurrentPwaTabId = label;
                StateHasChanged();
            }
        }
    }

    [JSInvokable]
    public void OnAdblockStatsUpdate(AdblockStatsPayload payload)
    {
        var tab = Tabs.FirstOrDefault(t => t.Id == payload.Label);
        if (tab != null)
        {
            tab.BlockedAdsCount = payload.BlockedCount;
            // Only update UI if this is the active tab
            if (ActiveTabId == payload.Label)
            {
                StateHasChanged();
            }
        }
    }

    private async Task InstallPwa()
    {
        if (!string.IsNullOrEmpty(CurrentPwaTabId) && !IsInstallingPwa)
        {
            IsInstallingPwa = true;
            StateHasChanged();
            
            try
            {
                await JsRuntime.InvokeVoidAsync("__TAURI__.core.invoke", "install_pwa", new { label = CurrentPwaTabId });
                // Reset state after a delay to allow re-attempts if needed
                await Task.Delay(2000);
            }
            finally
            {
                IsInstallingPwa = false;
                StateHasChanged();
            }
        }
    }

    [JSInvokable]
    public async Task OnTabNavigation(string label, string url)
    {
        var tab = Tabs.FirstOrDefault(t => t.Id == label);
        if (tab != null)
        {
            tab.Url = url;
            
            // Extract site name from URL (e.g. https://www.google.com -> Google.com)
            try 
            {
                if (Uri.TryCreate(url, UriKind.Absolute, out var uri))
                {
                    var host = uri.Host;
                    if (host.StartsWith("www."))
                    {
                        host = host.Substring(4);
                    }
                    
                    if (!string.IsNullOrEmpty(host))
                    {
                        // Capitalize first letter
                        tab.Title = char.ToUpper(host[0]) + host.Substring(1);
                    }
                    else
                    {
                         tab.Title = uri.Host;
                    }
                }
                else
                {
                    tab.Title = url;
                }
            }
            catch
            {
                tab.Title = url;
            }
            
            tab.FaviconUrl = string.Empty; // Reset favicon on navigation
            tab.IsPwaAvailable = false; // Reset PWA status
            
            if (ActiveTabId == label)
            {
                CurrentUrl = url;
                IsPwaAvailable = false;
                await CheckFavoriteStatus();
            }
            StateHasChanged();
        }

        try
        {
            await JsRuntime.InvokeVoidAsync("__TAURI__.core.invoke", "add_history_item", new { url = url, title = url });
            if (IsMenuOpen && MenuTab == "history") await LoadHistory();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error adding history: {ex.Message}");
        }
    }

    private async Task ToggleMenu()
    {
        IsMenuOpen = !IsMenuOpen;
        StateHasChanged();
        
        try 
        {
            await JsRuntime.InvokeVoidAsync("__TAURI__.core.invoke", "toggle_sidebar", new { open = IsMenuOpen });
        }
        catch (Exception ex) { Console.WriteLine($"Error toggling sidebar: {ex.Message}"); }

        if (IsMenuOpen)
        {
            await LoadHistory();
            await LoadFavorites();
        }
    }
    
    private async Task CloseMenu()
    {
        IsMenuOpen = false;
        StateHasChanged();
        try 
        {
            await JsRuntime.InvokeVoidAsync("__TAURI__.core.invoke", "toggle_sidebar", new { open = false });
        }
        catch (Exception ex) { Console.WriteLine($"Error closing sidebar: {ex.Message}"); }
    }

    private async Task LoadHistory()
    {
        try 
        {
            var history = await JsRuntime.InvokeAsync<List<HistoryItem>>("__TAURI__.core.invoke", "get_history");
            HistoryList = history ?? new List<HistoryItem>();
            StateHasChanged();
        }
        catch (Exception ex) { Console.WriteLine($"Error loading history: {ex.Message}"); }
    }

    private async Task LoadFavorites()
    {
        try
        {
            var favorites = await JsRuntime.InvokeAsync<List<FavoriteItem>>("__TAURI__.core.invoke", "get_favorites");
            FavoritesList = favorites ?? new List<FavoriteItem>();
            StateHasChanged();
        }
        catch (Exception ex) { Console.WriteLine($"Error loading favorites: {ex.Message}"); }
    }
    
    private async Task LoadSettings()
    {
        try
        {
            var settings = await JsRuntime.InvokeAsync<AppSettings>("__TAURI__.core.invoke", "get_settings");
            if (settings != null) Settings = settings;
        }
        catch (Exception ex) { Console.WriteLine($"Error loading settings: {ex.Message}"); }
    }
    
    private async Task SaveSettings()
    {
        // Normalize homepage URL
        if (!string.IsNullOrWhiteSpace(Settings.Homepage) && 
            !Settings.Homepage.StartsWith("http") && 
            !Settings.Homepage.StartsWith("file"))
        {
            Settings.Homepage = "https://" + Settings.Homepage;
        }

        try
        {
            await JsRuntime.InvokeVoidAsync("__TAURI__.core.invoke", "save_settings", new { 
                homepage = Settings.Homepage, 
                searchEngine = Settings.SearchEngine,
                theme = Settings.Theme,
                accentColor = Settings.AccentColor,
                verticalTabs = Settings.VerticalTabs,
                roundedCorners = Settings.RoundedCorners
            });
            
            // Trigger a resize if vertical tabs changed
            // We need to tell Rust to re-evaluate the layout
             await JsRuntime.InvokeVoidAsync("__TAURI__.core.invoke", "toggle_sidebar", new { open = IsMenuOpen });
             // Or maybe create a specific 'update_layout' command? 
             // Toggle sidebar handles main webview resizing.
             
        }
        catch (Exception ex) { Console.WriteLine($"Error saving settings: {ex.Message}"); }
    }
    
    private async Task ToggleFavorite()
    {
        try
        {
            if (IsCurrentFavorite)
            {
                await JsRuntime.InvokeVoidAsync("__TAURI__.core.invoke", "remove_favorite", new { url = CurrentUrl });
            }
            else
            {
                await JsRuntime.InvokeVoidAsync("__TAURI__.core.invoke", "add_favorite", new { url = CurrentUrl, title = CurrentUrl });
            }
            await LoadFavorites();
            await CheckFavoriteStatus();
        }
        catch (Exception ex) { Console.WriteLine($"Error toggling favorite: {ex.Message}"); }
    }
    
    private async Task RemoveFavorite(string url)
    {
         try
         {
             await JsRuntime.InvokeVoidAsync("__TAURI__.core.invoke", "remove_favorite", new { url = url });
             await LoadFavorites();
             if (CurrentUrl == url) await CheckFavoriteStatus();
         }
         catch (Exception ex) { Console.WriteLine($"Error removing favorite: {ex.Message}"); }
    }

    private async Task CheckFavoriteStatus()
    {
        await LoadFavorites(); // Ensure list is up to date
        IsCurrentFavorite = FavoritesList.Any(f => f.Url == CurrentUrl);
        StateHasChanged();
    }
    
    private async Task LoadUrl(string url)
    {
        CurrentUrl = url;
        await Navigate();
        await CloseMenu();
    }

    [JSInvokable]
    public async Task OnNewTabRequested(TabCreatedPayload payload)
    {
        await CreateTabWithUrl(payload.Url);
    }

    private async Task CreateTabWithUrl(string url)
    {
        if (string.IsNullOrWhiteSpace(url)) url = Settings.Homepage;
        if (string.IsNullOrWhiteSpace(url)) url = "https://www.google.com";
        if (!url.StartsWith("http") && !url.StartsWith("file")) url = "https://" + url;

        var title = "Yeni Sekme";
        try 
        {
             if (Uri.TryCreate(url, UriKind.Absolute, out var uri))
             {
                 title = uri.Host;
             }
        }
        catch {}
        
        var newTab = new BrowserTab { Title = title, Url = url };
        Tabs.Add(newTab);
        
        ActiveTabId = newTab.Id;
        CurrentUrl = newTab.Url;
        StateHasChanged(); 
        
        try 
        {
            await JsRuntime.InvokeVoidAsync("__TAURI__.core.invoke", "create_tab", new { label = newTab.Id, url = newTab.Url });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error creating tab in Rust: {ex.Message}");
        }
    }

    private async Task CreateNewTab()
    {
        // Use homepage from settings
        var url = Settings.Homepage;
        if (string.IsNullOrWhiteSpace(url)) url = "https://www.google.com";
        if (!url.StartsWith("http") && !url.StartsWith("file")) url = "https://" + url;

        var title = "Yeni Sekme";
        if (url.Contains("google")) title = "Google";
        
        var newTab = new BrowserTab { Title = title, Url = url };
        Tabs.Add(newTab);
        
        // Don't set active tab immediately in UI until confirmed? 
        // No, optimistic update is fine.
        ActiveTabId = newTab.Id;
        CurrentUrl = newTab.Url;
        StateHasChanged(); // Refresh UI to show new tab
        
        try 
        {
            await JsRuntime.InvokeVoidAsync("__TAURI__.core.invoke", "create_tab", new { label = newTab.Id, url = newTab.Url });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error creating tab in Rust: {ex.Message}");
        }
    }

    private async Task SwitchTab(string tabId)
    {
        if (ActiveTabId == tabId) return;

        ActiveTabId = tabId;
        var tab = Tabs.First(t => t.Id == tabId);
        CurrentUrl = tab.Url;
        IsPwaAvailable = tab.IsPwaAvailable;
        CurrentPwaTabId = tab.Id;
        
        try 
        {
             await JsRuntime.InvokeVoidAsync("__TAURI__.core.invoke", "switch_tab", new { label = tabId });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error switching tab: {ex.Message}");
        }
    }

    private async Task CloseTab(string tabId)
    {
        var tab = Tabs.FirstOrDefault(t => t.Id == tabId);
        if (tab == null) return;

        // Determine next tab to activate if we are closing the active one
        string? nextTabId = ActiveTabId;
        if (ActiveTabId == tabId)
        {
            var index = Tabs.IndexOf(tab);
            if (Tabs.Count > 1)
            {
                // Try to go to the previous tab, or next if first
                var nextTab = index > 0 ? Tabs[index - 1] : Tabs[index + 1];
                nextTabId = nextTab.Id;
            }
            else 
            {
                // Closing last tab, we'll create a new one later
                nextTabId = null;
            }
        }

        Tabs.Remove(tab);
        
        try 
        {
            await JsRuntime.InvokeVoidAsync("__TAURI__.core.invoke", "close_tab", new { label = tabId });
        }
         catch (Exception ex)
        {
            Console.WriteLine($"Error closing tab: {ex.Message}");
        }

        if (nextTabId != null && ActiveTabId == tabId)
        {
            await SwitchTab(nextTabId);
        }
        else if (!Tabs.Any())
        {
            await CreateNewTab();
        }
    }

    private async Task HandleCommandPaletteNavigate(string query)
    {
        CurrentUrl = query;
        await Navigate();
    }
    
    private async Task Navigate()
    {
        if (string.IsNullOrWhiteSpace(CurrentUrl)) return;

        string targetUrl = CurrentUrl.Trim();
        
        // Internal Pages Interception
        if (targetUrl.StartsWith("lumina://", StringComparison.OrdinalIgnoreCase))
        {
            var page = targetUrl.Substring(9).ToLower();
            if (page == "downloads") { IsMenuOpen = true; MenuTab = "downloads"; StateHasChanged(); return; }
            if (page == "history") { IsMenuOpen = true; MenuTab = "history"; StateHasChanged(); return; }
            if (page == "settings") { IsMenuOpen = true; MenuTab = "settings"; StateHasChanged(); return; }
            if (page == "favorites") { IsMenuOpen = true; MenuTab = "favorites"; StateHasChanged(); return; }
            if (page == "network") { IsMenuOpen = true; MenuTab = "network"; StateHasChanged(); return; }
        }
        
        // Basic Smart Search / Omnibox Logic
        bool isUrl = false;
        
        // Check for protocol
            if (targetUrl.StartsWith("http://", StringComparison.OrdinalIgnoreCase) || 
                targetUrl.StartsWith("https://", StringComparison.OrdinalIgnoreCase) ||
                targetUrl.StartsWith("file://", StringComparison.OrdinalIgnoreCase) ||
                targetUrl.StartsWith("lumina://", StringComparison.OrdinalIgnoreCase))
            {
                isUrl = true;
            }
        else
        {
            // Regex to check if it looks like a domain (e.g., example.com, sub.domain.org)
            // Simple check: no spaces and contains a dot
            if (!targetUrl.Contains(" ") && targetUrl.Contains("."))
            {
                 isUrl = true;
                 targetUrl = "https://" + targetUrl;
            }
        }

        if (!isUrl)
        {
            switch (Settings.SearchEngine)
            {
                case "bing":
                    targetUrl = "https://www.bing.com/search?q=" + System.Net.WebUtility.UrlEncode(targetUrl);
                    break;
                case "duckduckgo":
                    targetUrl = "https://duckduckgo.com/?q=" + System.Net.WebUtility.UrlEncode(targetUrl);
                    break;
                default:
                    targetUrl = "https://www.google.com/search?q=" + System.Net.WebUtility.UrlEncode(targetUrl);
                    break;
            }
        }

        // CurrentUrl = targetUrl; // Don't update UI immediately for better UX (show search term)

        var tab = Tabs.FirstOrDefault(t => t.Id == ActiveTabId);
        if (tab != null)
        {
            // tab.Url = CurrentUrl; // Wait for navigation event to update
            // Ideally we get title update from Rust, but for now set URL as title
            // tab.Title = CurrentUrl; 
        }

        Console.WriteLine($"Navigating tab {ActiveTabId} to: {targetUrl}");
        try
        {
            await JsRuntime.InvokeVoidAsync("__TAURI__.core.invoke", "navigate", new { label = ActiveTabId, url = targetUrl });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error invoking navigate: {ex.Message}");
        }
    }

    private async Task OpenFile(string path)
    {
        try
        {
            await JsRuntime.InvokeVoidAsync("__TAURI__.core.invoke", "open_file", new { path = path });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error opening file: {ex.Message}");
        }
    }

    private async Task ShowInFolder(string path)
    {
        try
        {
            await JsRuntime.InvokeVoidAsync("__TAURI__.core.invoke", "show_in_folder", new { path = path });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error showing file in folder: {ex.Message}");
        }
    }

    private async Task CopyLink(string url)
    {
        try
        {
            await JsRuntime.InvokeVoidAsync("navigator.clipboard.writeText", url);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error copying link: {ex.Message}");
        }
    }

    private async Task ToggleReaderMode()
    {
        if (!string.IsNullOrEmpty(ActiveTabId))
        {
            try 
            {
                await JsRuntime.InvokeVoidAsync("__TAURI__.core.invoke", "toggle_reader_mode", new { label = ActiveTabId });
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error toggling reader mode: {ex.Message}");
            }
        }
    }

    private void ClearDownloads()
    {
        DownloadsList.Clear();
        StateHasChanged();
    }

    private async Task GoBack()
    {
        await JsRuntime.InvokeVoidAsync("__TAURI__.core.invoke", "go_back", new { label = ActiveTabId });
    }

    private async Task GoForward()
    {
        await JsRuntime.InvokeVoidAsync("__TAURI__.core.invoke", "go_forward", new { label = ActiveTabId });
    }

    private async Task Refresh()
    {
        await JsRuntime.InvokeVoidAsync("__TAURI__.core.invoke", "refresh", new { label = ActiveTabId });
    }

    private async Task HandleKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
             // Close suggestions
             Suggestions.Clear();
             _suggestionsLayoutPending = true;
             StateHasChanged(); // Ensure UI updates

            await Navigate();
            return;
        }
        
         if (e.Key == "Escape")
        {
            Suggestions.Clear();
             _suggestionsLayoutPending = true;
             StateHasChanged();
            return;
        }

        // Debounce logic could go here, for now we just update on every keyup that modifies text
        // (Handled by oninput mostly, but keyup catches some edge cases)
        // If we want real-time search suggestions as they type:
        if (!string.IsNullOrWhiteSpace(CurrentUrl) && e.Key != "Enter" && e.Key != "Escape")
        {
            // Simple logic: if text is long enough, search history
            if (CurrentUrl.Length > 1)
            {
               await SearchHistory(CurrentUrl);
            }
        }
    }

    // Network Sidecar Logic
    private string NetworkStatus = "Ready";
    private List<string> NetworkLogs = new();
    private int NetworkPort = 8080;

    private async Task StartServer()
    {
        var payload = System.Text.Json.JsonSerializer.Serialize(new { port = NetworkPort, type = "tcp" });
        await RunNetworkCommand("start_server", payload);
    }

    private async Task StopServer()
    {
        await RunNetworkCommand("stop_server", "{}");
    }

    private async Task RunNetworkCommand(string command, string payloadJson)
    {
        NetworkLogs.Add($"Sending: {command} {payloadJson}");
        try
        {
             var response = await JsRuntime.InvokeAsync<string>("__TAURI__.core.invoke", "run_networking_command", 
                new { command = command, payload = payloadJson });
             
             NetworkLogs.Add($"Response: {response}");
             
             // Update status if it's a status command
             if (command == "status")
             {
                 try {
                    using var doc = System.Text.Json.JsonDocument.Parse(response);
                    if (doc.RootElement.TryGetProperty("status", out var statusProp))
                    {
                        NetworkStatus = statusProp.GetString() ?? "Unknown";
                    }
                 } catch {}
             }
        }
        catch (Exception ex)
        {
             NetworkLogs.Add($"Error: {ex.Message}");
             NetworkStatus = "Error";
        }
        StateHasChanged();
    }
}