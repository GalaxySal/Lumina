name: Release
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  release:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        platform: [macos-latest, ubuntu-22.04, windows-latest]
    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x' 

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache-dependency-path: src-go/go.mod

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.11.0

      - name: Rust setup
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Determine Sidecar Target
        shell: bash
        run: |
          if [[ "${{ matrix.platform }}" == "windows-latest" ]]; then
            echo "SIDECAR_TRIPLE=x86_64-pc-windows-msvc" >> $GITHUB_ENV
            echo "EXE_EXT=.exe" >> $GITHUB_ENV
          elif [[ "${{ matrix.platform }}" == "macos-latest" ]]; then
            if [[ $(uname -m) == "arm64" ]]; then
               echo "SIDECAR_TRIPLE=aarch64-apple-darwin" >> $GITHUB_ENV
            else
               echo "SIDECAR_TRIPLE=x86_64-apple-darwin" >> $GITHUB_ENV
            fi
            echo "EXE_EXT=" >> $GITHUB_ENV
          else
            echo "SIDECAR_TRIPLE=x86_64-unknown-linux-gnu" >> $GITHUB_ENV
            echo "EXE_EXT=" >> $GITHUB_ENV
          fi

      - name: Build Sidecars
        shell: bash
        run: |
          mkdir -p src-tauri/binaries
          
          # Build Kip (Rust)
          echo "Building Kip..."
          cargo build --release --manifest-path src-kip/Cargo.toml
          cp src-kip/target/release/kip-rs${{ env.EXE_EXT }} src-tauri/binaries/kip-lang-${{ env.SIDECAR_TRIPLE }}${{ env.EXE_EXT }}
          
          # Build Lumina-Net (Go)
          echo "Building Lumina-Net..."
          cd src-go
          go build -o ../src-tauri/binaries/lumina-net-${{ env.SIDECAR_TRIPLE }}${{ env.EXE_EXT }} main.go
          cd .. 

      - name: Install dependencies (Ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev build-essential curl wget libssl-dev file

      - name: Install Tauri CLI
        run: cargo install tauri-cli --version "^2.0.0" --locked

      - name: Get Version
        shell: bash
        run: |
          VERSION=$(jq -r '.version' src-tauri/tauri.conf.json)
          echo "PACKAGE_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Generate Release Notes
        shell: bash
        run: |
          # Fetch tags
          git fetch --tags
          
          # Get latest existing tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LATEST_TAG" ]; then
            echo "No tags found. Generating notes from the beginning."
            GIT_LOG=$(git log --pretty=format:"%s")
          else
            echo "Generating notes since tag: $LATEST_TAG"
            GIT_LOG=$(git log --pretty=format:"%s" "$LATEST_TAG..HEAD")
          fi
          
          FEATURES=""
          FIXES=""
          CHORES=""
          OTHERS=""
          
          while IFS= read -r line; do
            if [[ $line =~ ^feat ]]; then
              FEATURES+="- ${line#*: }\n"
            elif [[ $line =~ ^fix ]]; then
              FIXES+="- ${line#*: }\n"
            elif [[ $line =~ ^chore ]]; then
              CHORES+="- ${line#*: }\n"
            elif [ -n "$line" ]; then
              OTHERS+="- $line\n"
            fi
          done <<< "$GIT_LOG"
          
          BODY=""
          if [ -n "$FEATURES" ]; then BODY+="## ðŸš€ Features\n$FEATURES\n"; fi
          if [ -n "$FIXES" ]; then BODY+="## ðŸ› Fixes\n$FIXES\n"; fi
          if [ -n "$CHORES" ]; then BODY+="## ðŸ”§ Chores & Improvements\n$CHORES\n"; fi
          if [ -n "$OTHERS" ]; then BODY+="## ðŸ“‹ Other Changes\n$OTHERS\n"; fi
          
          if [ -z "$BODY" ]; then
            BODY="No significant changes detected."
          fi

          echo "RELEASE_NOTES<<EOF" >> $GITHUB_ENV
          echo -e "$BODY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Build the app
        run: cargo tauri build

      - name: Prepare Portable Exe (Windows)
        if: matrix.platform == 'windows-latest'
        shell: pwsh
        run: |
          $src = "src-tauri/target/release/lumina-browser.exe"
          if (!(Test-Path $src)) {
              Write-Host "lumina-browser.exe not found at standard path. Searching..."
              $found = Get-ChildItem -Path "src-tauri/target" -Filter "lumina-browser.exe" -Recurse | Select-Object -First 1
              if ($found) {
                  $src = $found.FullName
              } else {
                  Write-Error "Could not find lumina-browser.exe in src-tauri/target"
                  Get-ChildItem -Path "src-tauri/target" -Recurse
                  exit 1
              }
          }
          Write-Host "Found exe at: $src"
          Copy-Item $src -Destination "src-tauri/target/release/Lumina-Portable.exe"

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            src-tauri/target/release/bundle/nsis/*.exe
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/dmg/*.dmg
            src-tauri/target/release/bundle/appimage/*.AppImage
            src-tauri/target/release/bundle/deb/*.deb
            src-tauri/target/release/bundle/rpm/*.rpm
            src-tauri/target/release/Lumina-Portable.exe
          tag_name: v${{ env.PACKAGE_VERSION }}
          name: Lumina v${{ env.PACKAGE_VERSION }}
          body: ${{ env.RELEASE_NOTES }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
