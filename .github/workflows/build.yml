name: Release
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  release:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        platform: [macos-latest, ubuntu-22.04, windows-latest]
    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x' 

      - name: Install dependencies (Ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev build-essential curl wget libssl-dev file

      - name: Rust setup
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Install Tauri CLI
        run: cargo install tauri-cli --version "^2.0.0" --locked

      - name: Get Version
        shell: bash
        run: |
          VERSION=$(grep -oP '"version":\s*"\K[^"]+' src-tauri/tauri.conf.json)
          echo "PACKAGE_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Generate Release Notes
        shell: bash
        run: |
          # Fetch tags
          git fetch --tags
          
          # Get latest existing tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LATEST_TAG" ]; then
            echo "No tags found. Generating notes from the beginning."
            GIT_LOG=$(git log --pretty=format:"%s")
          else
            echo "Generating notes since tag: $LATEST_TAG"
            GIT_LOG=$(git log --pretty=format:"%s" "$LATEST_TAG..HEAD")
          fi
          
          FEATURES=""
          FIXES=""
          CHORES=""
          OTHERS=""
          
          while IFS= read -r line; do
            if [[ $line =~ ^feat ]]; then
              FEATURES+="- ${line#*: }\n"
            elif [[ $line =~ ^fix ]]; then
              FIXES+="- ${line#*: }\n"
            elif [[ $line =~ ^chore ]]; then
              CHORES+="- ${line#*: }\n"
            elif [ -n "$line" ]; then
              OTHERS+="- $line\n"
            fi
          done <<< "$GIT_LOG"
          
          BODY=""
          if [ -n "$FEATURES" ]; then BODY+="## ðŸš€ Features\n$FEATURES\n"; fi
          if [ -n "$FIXES" ]; then BODY+="## ðŸ› Fixes\n$FIXES\n"; fi
          if [ -n "$CHORES" ]; then BODY+="## ðŸ”§ Chores & Improvements\n$CHORES\n"; fi
          if [ -n "$OTHERS" ]; then BODY+="## ðŸ“‹ Other Changes\n$OTHERS\n"; fi
          
          if [ -z "$BODY" ]; then
            BODY="No significant changes detected."
          fi

          echo "RELEASE_NOTES<<EOF" >> $GITHUB_ENV
          echo -e "$BODY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Build the app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: v__VERSION__ # the action automatically replaces \_\_VERSION\_\_ with the app version
          releaseName: 'Lumina v__VERSION__'
          releaseBody: ${{ env.RELEASE_NOTES }}
          releaseDraft: false
          prerelease: false

      - name: Prepare and Upload Portable Exe (Windows)
        if: matrix.platform == 'windows-latest'
        shell: pwsh
        run: |
          Copy-Item "src-tauri/target/release/Lumina.exe" -Destination "src-tauri/target/release/Lumina-Portable.exe"
        
      - name: Upload Portable Asset
        if: matrix.platform == 'windows-latest'
        uses: softprops/action-gh-release@v1
        with:
          files: src-tauri/target/release/Lumina-Portable.exe
          tag_name: v${{ env.PACKAGE_VERSION }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
